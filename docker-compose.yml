version: "3"

services:

  nginx:
    restart: always
    build:
      context: ./
      dockerfile: ./services/nginx/Dockerfile
      args:
        environment: development
    env_file:
      - ./services/nginx/.env
      - ./.env
    ports:
    - "80:80"
    - "443:443"
    volumes:
    - static:/var/www/static:ro
    depends_on:
    - components
    - accounts
    networks:
    - front-tier
    - back-tier

  graphql:
    restart: always
    build:
      context: ./
      dockerfile: ./services/graphql/Dockerfile
      args:
        environment: development
    env_file:
      - ./services/graphql/.env
      - ./secret.env
      - ./.env
    expose:
    - "4000"
    networks:
    - back-tier

  accounts:
    restart: always
    build:
      context: ./
      dockerfile: ./services/accounts/Dockerfile
      args:
        environment: development
    expose:
    - "8000"
    volumes:
    - /home/django/app
    - static:/home/django/app/static
    env_file:
      - ./services/accounts/.env
      - ./secret.env
      - ./.env
    depends_on:
    - accounts-postgres
    - redis
    networks:
    - back-tier

  accounts-postgres:
    image: postgres:10
    container_name: accounts-postgres
    volumes:
    - "accounts-postgres:/var/lib/postgresql/data"
    networks:
    - back-tier

  components:
    restart: always
    build:
      context: ./
      dockerfile: ./services/components/Dockerfile
      args:
        environment: development
    expose:
    - "8000"
    volumes:
    - /home/django/app
    - static:/home/django/app/static
    env_file:
      - ./services/components/.env
      - ./secret.env
      - ./.env
    depends_on:
    - components-postgres
    - redis
    networks:
    - back-tier

  components-postgres:
    image: postgres:10
    container_name: components-postgres
    volumes:
    - "components-postgres:/var/lib/postgresql/data"
    networks:
    - back-tier

  redis:
    restart: always
    image: redis:5.0.0-alpine
    ports:
    - "6379"
    volumes:
    - redis:/data
    networks:
    - back-tier

volumes:
  static:
  components-postgres:
  accounts-postgres:
  redis:

networks:
  front-tier:
  back-tier:
